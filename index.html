<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>ERP المحاسبة والتصنيع – نسخة Firebase</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <style>
    :root{
      --bg:#0b1220;
      --card:#0f1a30;
      --card2:#101c33;
      --text:#e9eefc;
      --muted:#a9b5d3;
      --brand:#4f7cff;
      --good:#22c55e;
      --bad:#ef4444;
      --warn:#f59e0b;
      --line:rgba(255,255,255,.08);
      --shadow: 0 12px 40px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Cairo", system-ui, -apple-system, Segoe UI, Tahoma, Arial;
      background: radial-gradient(1200px 900px at 20% 0%, rgba(79,124,255,.22), transparent 60%),
                  radial-gradient(900px 700px at 90% 10%, rgba(34,197,94,.12), transparent 55%),
                  var(--bg);
      color:var(--text);
      min-height:100vh;
    }
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1180px;margin:0 auto;padding:18px 16px 90px}
    .topbar{
      position:sticky;top:0;z-index:20;
      backdrop-filter: blur(10px);
      background: rgba(11,18,32,.72);
      border-bottom:1px solid var(--line);
    }
    .topbar-inner{max-width:1180px;margin:0 auto;padding:12px 16px;display:flex;gap:12px;align-items:center;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{
      width:40px;height:40px;border-radius:14px;
      background: linear-gradient(135deg, rgba(79,124,255,.95), rgba(79,124,255,.25));
      display:grid;place-items:center;box-shadow: var(--shadow);
    }
    .logo i{font-size:18px}
    .brand h1{font-size:15px;margin:0;line-height:1.1}
    .brand small{display:block;color:var(--muted);font-size:12px;margin-top:2px}
    .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;color:var(--muted);font-size:12px;display:inline-flex;gap:8px;align-items:center}
    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      display:inline-flex;align-items:center;gap:8px;
      transition:.15s transform ease, .15s background ease, .15s border ease;
      user-select:none;
    }
    .btn:hover{transform: translateY(-1px);background: rgba(255,255,255,.06);border-color:rgba(255,255,255,.16)}
    .btn.primary{background: rgba(79,124,255,.18);border-color: rgba(79,124,255,.35)}
    .btn.primary:hover{background: rgba(79,124,255,.24)}
    .btn.danger{background: rgba(239,68,68,.14);border-color: rgba(239,68,68,.35)}
    .btn.good{background: rgba(34,197,94,.14);border-color: rgba(34,197,94,.35)}
    .grid{display:grid;grid-template-columns: 1fr;gap:14px}
    @media(min-width:900px){.grid{grid-template-columns: 1.2fr .8fr}}
    .card{
      background: linear-gradient(180deg, rgba(16,28,51,.92), rgba(15,26,48,.92));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-h{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px
    }
    .card-h h2{margin:0;font-size:14px}
    .card-h p{margin:4px 0 0;color:var(--muted);font-size:12px}
    .card-b{padding:14px}
    .kpis{display:grid;grid-template-columns: repeat(2,1fr);gap:10px}
    @media(min-width:640px){.kpis{grid-template-columns: repeat(4,1fr)}}
    .kpi{
      background: rgba(255,255,255,.03);
      border:1px solid var(--line);
      border-radius: 16px;
      padding:10px 10px;
      min-height:78px;
    }
    .kpi .t{color:var(--muted);font-size:12px}
    .kpi .v{font-size:18px;font-weight:700;margin-top:4px}
    .kpi .s{color:var(--muted);font-size:11px;margin-top:2px}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .field{display:flex;flex-direction:column;gap:6px;min-width:160px;flex:1}
    label{font-size:12px;color:var(--muted)}
    input, select, textarea{
      background: rgba(255,255,255,.03);
      border:1px solid var(--line);
      border-radius: 14px;
      padding:10px 12px;
      color:var(--text);
      outline:none;
      font-family:inherit;
    }
    textarea{min-height:90px;resize:vertical}
    table{width:100%;border-collapse:separate;border-spacing:0;overflow:hidden}
    th,td{padding:10px 10px;border-bottom:1px solid var(--line);font-size:12px;text-align:right}
    th{color:var(--muted);font-weight:600;background: rgba(255,255,255,.02)}
    tr:hover td{background: rgba(255,255,255,.02)}
    .tag{font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);color:var(--muted)}
    .muted{color:var(--muted)}
    .hide{display:none!important}
    .two{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:900px){.two{grid-template-columns:1fr 1fr}}
    .toast{
      position:fixed;left:16px;right:16px;bottom:86px;z-index:50;
      max-width:680px;margin:0 auto;
      background: rgba(0,0,0,.55);backdrop-filter: blur(10px);
      border:1px solid var(--line);border-radius: 16px;
      padding:12px 14px;display:none;gap:10px;align-items:flex-start
    }
    .toast.show{display:flex}
    .toast i{margin-top:2px}
    /* bottom nav */
    .bottom-nav{
      position:fixed;left:0;right:0;bottom:0;z-index:30;
      background: rgba(11,18,32,.86);
      border-top:1px solid var(--line);
      padding:10px 10px calc(10px + env(safe-area-inset-bottom));
      backdrop-filter: blur(10px);
    }
    .nav-inner{max-width:1180px;margin:0 auto;display:flex;gap:8px;justify-content:space-between}
    .nav-btn{
      flex:1;
      display:flex;flex-direction:column;gap:6px;align-items:center;justify-content:center;
      padding:10px 8px;border-radius:18px;
      border:1px solid transparent;
      color:var(--muted);
      user-select:none;
    }
    .nav-btn i{font-size:18px}
    .nav-btn span{font-size:11px}
    .nav-btn.active{color:var(--text);border-color:rgba(79,124,255,.35);background: rgba(79,124,255,.12)}
    /* desktop layout */
    .desktop{
      display:none;
    }
    @media(min-width:1000px){
      .bottom-nav{display:none}
      .wrap{padding-bottom:18px}
      .desktop{display:block}
      .layout{
        display:grid;
        grid-template-columns: 260px 1fr;
        gap:14px;
      }
      .sidebar{
        position:sticky;top:74px;height: calc(100vh - 90px);
      }
      .side-links{padding:10px;display:flex;flex-direction:column;gap:8px}
      .side-links .nav-btn{flex:none;flex-direction:row;justify-content:flex-start;gap:10px;padding:10px 12px;border:1px solid var(--line);background: rgba(255,255,255,.02)}
      .side-links .nav-btn.active{background: rgba(79,124,255,.12);border-color: rgba(79,124,255,.35)}
      .side-links .nav-btn span{font-size:12px}
    }
    .hr{height:1px;background:var(--line);margin:10px 0}
    .small{font-size:12px}
    .right{justify-content:flex-start}
    .danger-text{color:#ff8e8e}
    .good-text{color:#86efac}
  
/* Firebase login error panel */
.alert{margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,0,0,.08);color:#ffd7d7;font-size:13px;line-height:1.6}
.alert b{color:#fff}

</style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo"><i class="fa-solid fa-layer-group"></i></div>
        <div>
          <h1>ERP – المحاسبة والتصنيع</h1>
          <small id="envPill">Offline/Local</small>
        </div>
      </div>
      <div class="row">
        <span class="pill" id="userPill"><i class="fa-solid fa-circle-user"></i><span>زائر</span></span>
        <button class="btn" id="btnLogout" style="display:none"><i class="fa-solid fa-right-from-bracket"></i>خروج</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <!-- LOGIN -->
    <div id="loginView" class="card">
      <div class="card-h">
        <div>
          <h2>تسجيل الدخول</h2>
          <p>يدعم Firebase (Email/Password) مع “اسم مستخدم” مثل الأمين.</p>
        </div>
        <span class="tag">admin / admin123</span>
      </div>
      <div class="card-b">
        <div class="two">
          <div class="card" style="box-shadow:none">
            <div class="card-h">
              <div>
                <h2>دخول النظام</h2>
                <p class="muted">اكتب اسم المستخدم وكلمة المرور.</p>
              </div>
            </div>
            <div class="card-b">
              <div class="field">
                <label>اسم المستخدم</label>
                <input id="loginUser" placeholder="مثال: admin" autocomplete="username">
              </div>
              <div class="field" style="margin-top:10px">
                <label>كلمة المرور</label>
                <input id="loginPass" type="password" placeholder="••••••••" autocomplete="current-password">
              </div>
              <div class="row" style="margin-top:12px">
                <button class="btn primary" id="btnLogin"><i class="fa-solid fa-lock"></i>دخول</button>
                <button class="btn" id="btnShowConfig"><i class="fa-solid fa-gear"></i>إعدادات Firebase</button>
              
              <div id="loginError" class="alert hide"></div>
</div>
              <div id="configBox" class="hide" style="margin-top:12px">
                <div class="hr"></div>
                <p class="small muted">إذا أردت تغيير إعدادات Firebase، عدّل المتغير FIREBASE_CONFIG داخل الكود.</p>
              </div>
            </div>
          </div>

          <div class="card" style="box-shadow:none">
            <div class="card-h">
              <div>
                <h2>وضع البيانات</h2>
                <p class="muted">Firestore افتراضي (default) + صلاحيات. إن لم يتوفر اتصال، يعمل بالنسخة المحلية.</p>
              </div>
            </div>
            <div class="card-b">
              <ul class="small" style="margin:0; padding-right:18px; color:var(--muted); line-height:1.9">
                <li>تأكد من تفعيل: Authentication → Email/Password.</li>
                <li>تأكد من إنشاء: Firestore Database (default).</li>
                <li>أنشئ المستخدم: <span class="tag">admin@erb-sestem.local</span> بكلمة مرور <span class="tag">admin123</span>.</li>
                <li>ثم أضف صلاحياته في Firestore ضمن: <span class="tag">tenants/Main/users/{uid}</span>.</li>
              </ul>
              <div class="row" style="margin-top:10px">
                <button class="btn good" id="btnSeed"><i class="fa-solid fa-wand-magic-sparkles"></i>تجهيز حسابات افتراضية</button>
                <button class="btn" id="btnOpenDocs"><i class="fa-solid fa-book"></i>دليل سريع</button>
              </div>
              <div id="quickDoc" class="hide" style="margin-top:10px">
                <div class="hr"></div>
                <div class="small" style="color:var(--muted);line-height:1.9">
                  <b>البيانات الأساسية:</b><br/>
                  1) شجرة الحسابات → ثم قيود اليومية → ثم ميزان المراجعة.<br/>
                  2) شجرة المواد + BOM → أوامر إنتاج → تقارير تكلفة.<br/>
                  3) الصلاحيات تُدار من شاشة المستخدمين (Admin).
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- APP -->
    <div id="appView" class="hide">
      <div class="layout">
        <!-- desktop sidebar -->
        <div class="sidebar desktop">
          <div class="card">
            <div class="card-h">
              <div>
                <h2>القائمة</h2>
                <p class="muted">تنقل سريع</p>
              </div>
            </div>
            <div class="side-links">
              <a class="nav-btn" data-view="home"><i class="fa-solid fa-gauge-high"></i><span>الرئيسية</span></a>
              <a class="nav-btn" data-view="accounts"><i class="fa-solid fa-sitemap"></i><span>شجرة الحسابات</span></a>
              <a class="nav-btn" data-view="journal"><i class="fa-solid fa-receipt"></i><span>قيود اليومية</span></a>
              <a class="nav-btn" data-view="trial"><i class="fa-solid fa-scale-balanced"></i><span>ميزان المراجعة</span></a>
              <a class="nav-btn" data-view="balances"><i class="fa-solid fa-chart-column"></i><span>تقرير أرصدة</span></a>
              <a class="nav-btn" data-view="reports"><i class="fa-solid fa-file-lines"></i><span>مركز التقارير</span></a>
              <a class="nav-btn" data-view="ledger"><i class="fa-solid fa-book-open"></i><span>دفتر الأستاذ</span></a>
              <a class="nav-btn" data-view="statement"><i class="fa-solid fa-address-book"></i><span>كشف حساب عميل/مورد</span></a>
              <a class="nav-btn" data-view="cash"><i class="fa-solid fa-cash-register"></i><span>يومية الصندوق</span></a>
              <a class="nav-btn" data-view="payments"><i class="fa-solid fa-hand-holding-dollar"></i><span>مقبوضات/مدفوعات</span></a>
              
              <div class="hr"></div>
              <a class="nav-btn" data-view="items"><i class="fa-solid fa-boxes-stacked"></i><span>شجرة المواد</span></a>
              <a class="nav-btn" data-view="bom"><i class="fa-solid fa-diagram-project"></i><span>BOM التصنيع</span></a>
              <a class="nav-btn" data-view="production"><i class="fa-solid fa-industry"></i><span>أوامر إنتاج</span></a>
              <a class="nav-btn" data-view="cogs"><i class="fa-solid fa-coins"></i><span>تكلفة البضاعة المباعة</span></a>
              <div class="hr"></div>
              <a class="nav-btn" data-view="users"><i class="fa-solid fa-user-shield"></i><span>المستخدمون والصلاحيات</span></a>
              <a class="nav-btn" data-view="settings"><i class="fa-solid fa-gear"></i><span>الإعدادات</span></a>
            </div>
          </div>
        </div>

        <!-- main content -->
        <div>
          <!-- HOME -->
          <div class="card view" id="view-home">
            <div class="card-h">
              <div>
                <h2>لوحة التحكم</h2>
                <p>ملخص مالي سريع + تنقل للتقارير.</p>
              </div>
              <div class="row">
                <span class="tag" id="roleTag">—</span>
                <button class="btn" id="btnRefreshHome"><i class="fa-solid fa-arrows-rotate"></i>تحديث</button>
              </div>
            </div>
            <div class="card-b">
              <div class="kpis">
                <div class="kpi"><div class="t">عدد الحسابات</div><div class="v" id="kpiAccounts">0</div><div class="s">شجرة الحسابات</div></div>
                <div class="kpi"><div class="t">عدد القيود</div><div class="v" id="kpiJournals">0</div><div class="s">اليومية</div></div>
                <div class="kpi"><div class="t">عدد المواد</div><div class="v" id="kpiItems">0</div><div class="s">المخزون</div></div>
                <div class="kpi"><div class="t">أوامر الإنتاج</div><div class="v" id="kpiProd">0</div><div class="s">التصنيع</div></div>
              </div>
              <div class="hr"></div>
              <div class="row">
                <button class="btn primary" data-go="trial"><i class="fa-solid fa-scale-balanced"></i>ميزان المراجعة</button>
                <button class="btn" data-go="balances"><i class="fa-solid fa-chart-column"></i>تقرير أرصدة</button>
                <button class="btn" data-go="journal"><i class="fa-solid fa-receipt"></i>قيد جديد</button>
                <button class="btn" data-go="production"><i class="fa-solid fa-industry"></i>أمر إنتاج</button>
              </div>
            </div>
          </div>

          <!-- ACCOUNTS -->
          <div class="card view hide" id="view-accounts">
            <div class="card-h">
              <div>
                <h2>شجرة الحسابات</h2>
                <p>إضافة/تعديل حسابات (مستويات) + ترقيم.</p>
              </div>
              <div class="row">
                <button class="btn good" id="btnAddAccount"><i class="fa-solid fa-plus"></i>حساب جديد</button>
                <button class="btn" id="btnReloadAccounts"><i class="fa-solid fa-arrows-rotate"></i></button>
              </div>
            </div>
            <div class="card-b">
              <div class="row">
                <div class="field">
                  <label>بحث</label>
                  <input id="accSearch" placeholder="ابحث بالاسم أو الكود">
                </div>
              </div>
              <div style="margin-top:12px;overflow:auto;max-height:55vh;border:1px solid var(--line);border-radius:16px">
                <table>
                  <thead><tr>
                    <th>الكود</th><th>الاسم</th><th>النوع</th><th>الأب</th><th>إجراءات</th>
                  </tr></thead>
                  <tbody id="accTable"></tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- JOURNAL -->
          <div class="card view hide" id="view-journal">
            <div class="card-h">
              <div>
                <h2>قيود اليومية</h2>
                <p>إنشاء قيد + بنود مدين/دائن مع توازن تلقائي.</p>
              </div>
              <div class="row">
                <button class="btn good" id="btnNewJournal"><i class="fa-solid fa-plus"></i>قيد جديد</button>
                <button class="btn" id="btnReloadJournals"><i class="fa-solid fa-arrows-rotate"></i></button>
              </div>
            </div>
            <div class="card-b">
              <div class="two">
                <div class="card" style="box-shadow:none">
                  <div class="card-h">
                    <div>
                      <h2>إنشاء قيد</h2>
                      <p class="muted">يجب أن يتساوى مجموع المدين مع الدائن.</p>
                    </div>
                  </div>
                  <div class="card-b">
                    <div class="row">
                      <div class="field">
                        <label>التاريخ</label>
                        <input id="jDate" type="date">
                      </div>
                      <div class="field">
                        <label>الوصف</label>
                        <input id="jMemo" placeholder="مثال: قيد افتتاحي">
                      </div>
                    </div>
                    <div class="hr"></div>
                    <div class="row">
                      <div class="field">
                        <label>الحساب</label>
                        <select id="jlAccount"></select>
                      </div>
                      <div class="field">
                        <label>مدين</label>
                        <input id="jlDebit" type="number" step="0.01" placeholder="0.00">
                      </div>
                      <div class="field">
                        <label>دائن</label>
                        <input id="jlCredit" type="number" step="0.01" placeholder="0.00">
                      </div>
                      <div class="field">
                        <label>مركز تكلفة (اختياري)</label>
                        <input id="jlCC" placeholder="مثال: إنتاج">
                      </div>
                      <button class="btn" id="btnAddLine"><i class="fa-solid fa-plus"></i>إضافة بند</button>
                    </div>

                    <div style="margin-top:12px;overflow:auto;border:1px solid var(--line);border-radius:16px">
                      <table>
                        <thead><tr><th>الحساب</th><th>مدين</th><th>دائن</th><th>مركز تكلفة</th><th></th></tr></thead>
                        <tbody id="jlTable"></tbody>
                      </table>
                    </div>

                    <div class="row" style="margin-top:12px;justify-content:space-between">
                      <div class="row">
                        <span class="tag">المدين: <b id="sumDebit">0.00</b></span>
                        <span class="tag">الدائن: <b id="sumCredit">0.00</b></span>
                        <span class="tag">الفرق: <b id="sumDiff">0.00</b></span>
                      </div>
                      <button class="btn primary" id="btnPostJournal"><i class="fa-solid fa-cloud-arrow-up"></i>حفظ وترحيل</button>
                    </div>
                  </div>
                </div>

                <div class="card" style="box-shadow:none">
                  <div class="card-h">
                    <div>
                      <h2>آخر القيود</h2>
                      <p class="muted">عرض سريع (آخر 50).</p>
                    </div>
                  </div>
                  <div class="card-b">
                    <div style="overflow:auto;max-height:55vh;border:1px solid var(--line);border-radius:16px">
                      <table>
                        <thead><tr><th>التاريخ</th><th>الوصف</th><th>الحالة</th><th></th></tr></thead>
                        <tbody id="journalsTable"></tbody>
                      </table>
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </div>

          <!-- TRIAL BALANCE -->
          <div class="card view hide" id="view-trial">
            <div class="card-h">
              <div>
                <h2>ميزان المراجعة</h2>
                <p>تجميع أرصدة الحسابات خلال فترة.</p>
              </div>
              <div class="row">
                <button class="btn primary" id="btnRunTrial"><i class="fa-solid fa-play"></i>تشغيل</button>
                <button class="btn" id="btnPrintTrial"><i class="fa-solid fa-print"></i>طباعة</button>
              </div>
            </div>
            <div class="card-b">
              <div class="row">
                <div class="field"><label>من</label><input id="tFrom" type="date"></div>
                <div class="field"><label>إلى</label><input id="tTo" type="date"></div>
              </div>
              <div style="margin-top:12px;overflow:auto;max-height:58vh;border:1px solid var(--line);border-radius:16px">
                <table>
                  <thead><tr><th>الكود</th><th>الحساب</th><th>مدين</th><th>دائن</th><th>الرصيد</th></tr></thead>
                  <tbody id="trialTable"></tbody>
                  <tfoot>
                    <tr>
                      <th colspan="2">الإجمالي</th>
                      <th id="trialTD">0.00</th>
                      <th id="trialTC">0.00</th>
                      <th id="trialTB">0.00</th>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>
          </div>

          <!-- BALANCES -->
          <div class="card view hide" id="view-balances">
            <div class="card-h">
              <div>
                <h2>تقرير الأرصدة</h2>
                <p>أرصدة الحسابات + تصفية بالنوع.</p>
              </div>
              <div class="row">
                <select id="balType" class="btn" style="padding:10px 12px">
                  <option value="all">كل الأنواع</option>
                  <option value="asset">أصول</option>
                  <option value="liability">خصوم</option>
                  <option value="equity">حقوق ملكية</option>
                  <option value="revenue">إيرادات</option>
                  <option value="expense">مصروفات</option>
                </select>
                <button class="btn primary" id="btnRunBalances"><i class="fa-solid fa-play"></i>تشغيل</button>
                <button class="btn" id="btnPrintBalances"><i class="fa-solid fa-print"></i>طباعة</button>
              </div>
            </div>
            <div class="card-b">
              <div class="row">
                <div class="field"><label>حتى تاريخ</label><input id="bTo" type="date"></div>
              </div>
              <div style="margin-top:12px;overflow:auto;max-height:60vh;border:1px solid var(--line);border-radius:16px">
                <table>
                  <thead><tr><th>الكود</th><th>الحساب</th><th>الرصيد</th></tr></thead>
                  <tbody id="balancesTable"></tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- ITEMS -->
          <div class="card view hide" id="view-items">
            <div class="card-h">
              <div>
                <h2>شجرة المواد</h2>
                <p>مواد خام / تحت التشغيل / تامة الصنع / خدمات.</p>
              </div>
              <div class="row">
                <button class="btn good" id="btnAddItem"><i class="fa-solid fa-plus"></i>مادة جديدة</button>
                <button class="btn" id="btnReloadItems"><i class="fa-solid fa-arrows-rotate"></i></button>
              </div>
            </div>
            <div class="card-b">
              <div class="row">
                <div class="field"><label>بحث</label><input id="itemSearch" placeholder="اسم/كود"></div>
              </div>
              <div style="margin-top:12px;overflow:auto;max-height:60vh;border:1px solid var(--line);border-radius:16px">
                <table>
                  <thead><tr><th>الكود</th><th>الاسم</th><th>النوع</th><th>تكلفة (متوسط)</th><th>رصيد</th><th></th></tr></thead>
                  <tbody id="itemsTable"></tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- BOM -->
          <div class="card view hide" id="view-bom">
            <div class="card-h">
              <div>
                <h2>تعريف BOM التصنيع</h2>
                <p>مكوّنات المنتج (Bill of Materials).</p>
              </div>
              <div class="row">
                <button class="btn good" id="btnAddBOM"><i class="fa-solid fa-plus"></i>BOM جديد</button>
                <button class="btn" id="btnReloadBOM"><i class="fa-solid fa-arrows-rotate"></i></button>
              </div>
            </div>
            <div class="card-b">
              <div style="overflow:auto;max-height:62vh;border:1px solid var(--line);border-radius:16px">
                <table>
                  <thead><tr><th>المنتج</th><th>الوصف</th><th>عدد المكوّنات</th><th></th></tr></thead>
                  <tbody id="bomTable"></tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- PRODUCTION -->
          <div class="card view hide" id="view-production">
            <div class="card-h">
              <div>
                <h2>أوامر الإنتاج</h2>
                <p>استهلاك مواد + إنتاج منتج + قيد تصنيع.</p>
              </div>
              <div class="row">
                <button class="btn good" id="btnNewProd"><i class="fa-solid fa-plus"></i>أمر جديد</button>
                <button class="btn" id="btnReloadProd"><i class="fa-solid fa-arrows-rotate"></i></button>
              </div>
            </div>
            <div class="card-b">
              <div style="overflow:auto;max-height:62vh;border:1px solid var(--line);border-radius:16px">
                <table>
                  <thead><tr><th>التاريخ</th><th>المنتج</th><th>الكمية</th><th>الحالة</th><th></th></tr></thead>
                  <tbody id="prodTable"></tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- COGS -->
          <div class="card view hide" id="view-cogs">
            <div class="card-h">
              <div>
                <h2>حساب تكلفة البضاعة المباعة (COGS)</h2>
                <p>تقرير مبسط + قيود تلقائية عند البيع (نموذج).</p>
              </div>
              <div class="row">
                <button class="btn primary" id="btnRunCOGS"><i class="fa-solid fa-play"></i>تشغيل</button>
              </div>
            </div>
            <div class="card-b">
              <div class="row">
                <div class="field"><label>من</label><input id="cFrom" type="date"></div>
                <div class="field"><label>إلى</label><input id="cTo" type="date"></div>
              </div>
              <div class="hr"></div>
              <div class="small muted" style="line-height:1.9">
                هذا التقرير يقرأ قيود اليومية التي من نوع <span class="tag">SALE_COGS</span> ويجمع تكلفة المبيعات.
              </div>
              <div class="hr"></div>
              <div class="kpi" style="min-height:auto">
                <div class="t">إجمالي تكلفة البضاعة المباعة</div>
                <div class="v" id="cogsTotal">0.00</div>
                <div class="s">حسب القيود المولدة</div>
              </div>
            </div>
          </div>

          <!-- USERS -->
          <div class="card view hide" id="view-users">
            <div class="card-h">
              <div>
                <h2>المستخدمون والصلاحيات</h2>
                <p>تحديد صلاحيات لكل مستخدم (Admin فقط).</p>
              </div>
              <div class="row">
                <button class="btn good" id="btnAddUserPerm"><i class="fa-solid fa-plus"></i>إضافة مستخدم (صلاحيات)</button>
                <button class="btn" id="btnReloadUsers"><i class="fa-solid fa-arrows-rotate"></i></button>
              </div>
            </div>
            <div class="card-b">
              <div class="small muted" style="line-height:1.9">
                إنشاء المستخدم نفسه يتم من Firebase Authentication (لأسباب أمنية)، ثم تضيف وثيقته هنا لتحديد الصلاحيات.
              </div>
              <div style="margin-top:12px;overflow:auto;max-height:62vh;border:1px solid var(--line);border-radius:16px">
                <table>
                  <thead><tr><th>UID</th><th>الاسم</th><th>الدور</th><th>نشط</th><th></th></tr></thead>
                  <tbody id="usersTable"></tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- SETTINGS -->
          <div class="card view hide" id="view-settings">
            <div class="card-h">
              <div>
                <h2>الإعدادات</h2>
                <p>الشركة + السنة المالية + الحسابات الافتراضية للتكلفة.</p>
              </div>
              <div class="row">
                <button class="btn" id="btnCompanyInfo"><i class="fa-solid fa-building"></i>بيانات الشركة</button>
                <button class="btn primary" id="btnSaveSettings"><i class="fa-solid fa-floppy-disk"></i>حفظ</button>
              </div>
            </div>
            <div class="card-b">
              <div class="two">
                <div>
                  <div class="field">
                    <label>اسم الشركة</label>
                    <input id="setCompanyName" placeholder="اسم الشركة">
                  </div>
                  <div class="field" style="margin-top:10px">
                    <label>السنة المالية (مثال 2026)</label>
                    <input id="setFY" type="number" min="2000" max="2100">
                  </div>
                  <div class="field" style="margin-top:10px">
                    <label>إقفال حتى تاريخ (اختياري)</label>
                    <input id="setLockTo" type="date">
                  </div>
                </div>
                <div>
                  <div class="field">
                    <label>حساب المخزون (Inventory)</label>
                    <select id="setAccInv"></select>
                  </div>
                  <div class="field" style="margin-top:10px">
                    <label>حساب تكلفة المبيعات (COGS)</label>
                    <select id="setAccCOGS"></select>
                  </div>
                  <div class="field" style="margin-top:10px">
                    <label>حساب المبيعات (Revenue)</label>
                    <select id="setAccSales"></select>
                  </div>
                  <div class="field" style="margin-top:10px">
                    <label>حساب الصندوق/البنك (Cash/Bank)</label>
                    <select id="setAccCash"></select>
                  </div>
                </div>
              </div>

              <div class="hr"></div>
              <div class="row">
                <button class="btn danger" id="btnLocalReset"><i class="fa-solid fa-trash"></i>مسح بيانات محلية</button>
                <button class="btn" id="btnExportLocal"><i class="fa-solid fa-file-export"></i>تصدير JSON</button>
                <button class="btn" id="btnImportLocal"><i class="fa-solid fa-file-import"></i>استيراد JSON</button>
                <input id="importFile" type="file" accept="application/json" class="hide">
              </div>
              <p class="small muted" style="margin-top:10px;line-height:1.9">
                * التصدير/الاستيراد هنا للنسخة المحلية. Firestore يمكن عمل نسخ احتياطي من Google Cloud لاحقًا.
              </p>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  
          <!-- REPORTS HUB -->
          <div class="card view hide" id="view-reports">
            <div class="card-h">
              <div>
                <h2>مركز التقارير</h2>
                <p>كل التقارير المالية في مكان واحد.</p>
              </div>
              <div class="row">
                <button class="btn" id="btnRefreshReports"><i class="fa-solid fa-arrows-rotate"></i></button>
              </div>
            </div>
            <div class="card-b">
              <div class="row">
                <button class="btn primary" data-go="trial"><i class="fa-solid fa-scale-balanced"></i>ميزان المراجعة</button>
                <button class="btn" data-go="balances"><i class="fa-solid fa-chart-column"></i>تقرير أرصدة</button>
                <button class="btn" data-go="ledger"><i class="fa-solid fa-book-open"></i>دفتر الأستاذ</button>
                <button class="btn" data-go="statement"><i class="fa-solid fa-address-book"></i>كشف حساب</button>
                <button class="btn" data-go="cash"><i class="fa-solid fa-cash-register"></i>يومية الصندوق</button>
                <button class="btn" data-go="cogs"><i class="fa-solid fa-coins"></i>COGS</button>
              </div>
              <div class="hr"></div>
              <div class="small muted" style="line-height:1.9">
                <b>ملاحظة:</b> التقارير تعتمد على قيود اليومية (journalLines). لإظهار كشف حساب عميل/مورد، استخدم شاشة "مقبوضات/مدفوعات" أو اربط العميل/المورد داخل بنود القيد.
              </div>
            </div>
          </div>

          <!-- LEDGER -->
          <div class="card view hide" id="view-ledger">
            <div class="card-h">
              <div>
                <h2>دفتر الأستاذ</h2>
                <p>حركة حساب محدد + رصيد جاري.</p>
              </div>
              <div class="row">
                <button class="btn good" id="btnRunLedger"><i class="fa-solid fa-play"></i>عرض</button>
                <button class="btn" id="btnPrintLedger"><i class="fa-solid fa-print"></i>طباعة</button>
              </div>
            </div>
            <div class="card-b">
              <div class="row">
                <div class="field">
                  <label>الحساب</label>
                  <select id="ledAcc"></select>
                </div>
                <div class="field">
                  <label>من</label>
                  <input type="date" id="ledFrom">
                </div>
                <div class="field">
                  <label>إلى</label>
                  <input type="date" id="ledTo">
                </div>
              </div>
              <div class="hr"></div>
              <div style="overflow:auto;max-height:55vh;border:1px solid var(--line);border-radius:16px">
                <table>
                  <thead><tr>
                    <th>التاريخ</th><th>البيان</th><th>مدين</th><th>دائن</th><th>الرصيد</th><th>قيد</th>
                  </tr></thead>
                  <tbody id="ledgerTable"></tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- STATEMENT -->
          <div class="card view hide" id="view-statement">
            <div class="card-h">
              <div>
                <h2>كشف حساب مورد / عميل</h2>
                <p>حركة العميل/المورد ضمن الفترة + رصيد.</p>
              </div>
              <div class="row">
                <button class="btn good" id="btnRunStmt"><i class="fa-solid fa-play"></i>عرض</button>
                <button class="btn" id="btnPrintStmt"><i class="fa-solid fa-print"></i>طباعة</button>
              </div>
            </div>
            <div class="card-b">
              <div class="row">
                <div class="field">
                  <label>النوع</label>
                  <select id="stmtType">
                    <option value="customer">عميل</option>
                    <option value="supplier">مورد</option>
                  </select>
                </div>
                <div class="field">
                  <label>الاسم</label>
                  <select id="stmtPartner"></select>
                </div>
                <div class="field">
                  <label>من</label>
                  <input type="date" id="stmtFrom">
                </div>
                <div class="field">
                  <label>إلى</label>
                  <input type="date" id="stmtTo">
                </div>
                <button class="btn" id="btnAddPartner"><i class="fa-solid fa-user-plus"></i>إضافة عميل/مورد</button>
              </div>
              <div class="hr"></div>
              <div class="row">
                <span class="pill"><i class="fa-solid fa-coins"></i><span id="stmtBal">0.00</span></span>
              </div>
              <div style="margin-top:10px;overflow:auto;max-height:55vh;border:1px solid var(--line);border-radius:16px">
                <table>
                  <thead><tr>
                    <th>التاريخ</th><th>البيان</th><th>مدين</th><th>دائن</th><th>الرصيد</th><th>قيد</th>
                  </tr></thead>
                  <tbody id="stmtTable"></tbody>
                </table>
              </div>
              <div class="small muted" style="margin-top:10px;line-height:1.9">
                <b>مهم:</b> ليظهر السطر داخل كشف الحساب يجب أن يحتوي بند القيد على <span class="tag">partnerId</span>. شاشة "مقبوضات/مدفوعات" تضيف ذلك تلقائياً.
              </div>
            </div>
          </div>

          <!-- CASH JOURNAL -->
          <div class="card view hide" id="view-cash">
            <div class="card-h">
              <div>
                <h2>يومية الصندوق</h2>
                <p>يومية نقدية حسب حساب الصندوق المحدد في الإعدادات.</p>
              </div>
              <div class="row">
                <button class="btn good" id="btnRunCash"><i class="fa-solid fa-play"></i>عرض</button>
                <button class="btn" id="btnPrintCash"><i class="fa-solid fa-print"></i>طباعة</button>
              </div>
            </div>
            <div class="card-b">
              <div class="row">
                <div class="field">
                  <label>من</label>
                  <input type="date" id="cashFrom">
                </div>
                <div class="field">
                  <label>إلى</label>
                  <input type="date" id="cashTo">
                </div>
                <div class="field">
                  <label>حساب الصندوق</label>
                  <select id="cashAcc"></select>
                </div>
              </div>
              <div class="hr"></div>
              <div style="overflow:auto;max-height:55vh;border:1px solid var(--line);border-radius:16px">
                <table>
                  <thead><tr>
                    <th>التاريخ</th><th>البيان</th><th>مقبوضات</th><th>مدفوعات</th><th>الرصيد</th><th>قيد</th>
                  </tr></thead>
                  <tbody id="cashTable"></tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- RECEIPTS / PAYMENTS -->
          <div class="card view hide" id="view-payments">
            <div class="card-h">
              <div>
                <h2>المقبوضات والمدفوعات</h2>
                <p>سندات متعددة الأسطر (تولد قيود يومية تلقائياً).</p>
              </div>
              <div class="row">
                <button class="btn good" id="btnNewDoc"><i class="fa-solid fa-plus"></i>سند جديد</button>
                <button class="btn" id="btnReloadDocs"><i class="fa-solid fa-arrows-rotate"></i></button>
              </div>
            </div>
            <div class="card-b">
              <div class="two">
                <div class="card" style="box-shadow:none">
                  <div class="card-h">
                    <div>
                      <h2>إنشاء سند</h2>
                      <p class="muted">سند قبض/صرف متعدد البنود</p>
                    </div>
                  </div>
                  <div class="card-b">
                    <div class="row">
                      <div class="field">
                        <label>النوع</label>
                        <select id="docType">
                          <option value="receipt">سند قبض (مقبوضات)</option>
                          <option value="payment">سند صرف (مدفوعات)</option>
                        </select>
                      </div>
                      <div class="field">
                        <label>التاريخ</label>
                        <input type="date" id="docDate">
                      </div>
                      <div class="field">
                        <label>المرجع</label>
                        <input id="docRef" placeholder="رقم/مرجع">
                      </div>
                    </div>

                    <div class="row" style="margin-top:10px">
                      <div class="field">
                        <label>عميل/مورد (اختياري)</label>
                        <select id="docPartner"></select>
                      </div>
                      <div class="field">
                        <label>بيان</label>
                        <input id="docNote" placeholder="بيان السند">
                      </div>
                    </div>

                    <div class="hr"></div>
                    <div class="row">
                      <button class="btn" id="btnAddDocLine"><i class="fa-solid fa-plus"></i>إضافة سطر</button>
                      <span class="pill"><i class="fa-solid fa-hashtag"></i><span id="docLinesCount">0</span></span>
                      <span class="pill"><i class="fa-solid fa-coins"></i><span id="docTotal">0.00</span></span>
                    </div>
                    <div style="margin-top:10px;overflow:auto;max-height:30vh;border:1px solid var(--line);border-radius:16px">
                      <table>
                        <thead><tr><th>الحساب</th><th>المبلغ</th><th>إزالة</th></tr></thead>
                        <tbody id="docLinesTable"></tbody>
                      </table>
                    </div>

                    <div class="row" style="margin-top:10px">
                      <button class="btn primary" id="btnSaveDoc"><i class="fa-solid fa-floppy-disk"></i>حفظ وترحيل</button>
                    </div>

                    <div class="small muted" style="margin-top:10px;line-height:1.9">
                      <b>منطق القيود:</b><br/>
                      - القبض: <span class="tag">مدين</span> الصندوق/البنك، و<span class="tag">دائن</span> البنود.<br/>
                      - الصرف: <span class="tag">دائن</span> الصندوق/البنك، و<span class="tag">مدين</span> البنود.<br/>
                      حساب الصندوق يُحدد من الإعدادات.
                    </div>
                  </div>
                </div>

                <div class="card" style="box-shadow:none">
                  <div class="card-h">
                    <div>
                      <h2>سجل السندات (آخر 50)</h2>
                      <p class="muted">يمكن فتح القيد المرتبط</p>
                    </div>
                  </div>
                  <div class="card-b">
                    <div style="overflow:auto;max-height:55vh;border:1px solid var(--line);border-radius:16px">
                      <table>
                        <thead><tr><th>التاريخ</th><th>النوع</th><th>المرجع</th><th>الإجمالي</th><th>قيد</th></tr></thead>
                        <tbody id="docsTable"></tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
<!-- bottom navigation for mobile -->
  <div class="bottom-nav" id="bottomNav" style="display:none">
    <div class="nav-inner">
      <a class="nav-btn" data-view="home"><i class="fa-solid fa-gauge-high"></i><span>الرئيسية</span></a>
      <a class="nav-btn" data-view="accounts"><i class="fa-solid fa-sitemap"></i><span>الحسابات</span></a>
      <a class="nav-btn" data-view="journal"><i class="fa-solid fa-receipt"></i><span>اليومية</span></a>
      <a class="nav-btn" data-view="reports"><i class="fa-solid fa-file-lines"></i><span>تقارير</span></a>
      <a class="nav-btn" data-view="items"><i class="fa-solid fa-boxes-stacked"></i><span>المواد</span></a>
    </div>
  </div>

  <div class="toast" id="toast">
    <i id="toastIcon" class="fa-solid fa-circle-info"></i>
    <div>
      <div id="toastTitle" style="font-weight:700">رسالة</div>
      <div id="toastMsg" class="small muted">—</div>
    </div>
  </div>

  <script type="module">
    // =========================
    // Firebase (SCRIPT TAG – Modular)
    // =========================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
    import { getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, updateDoc, deleteDoc, query, orderBy, limit, where } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyAJFc1INw5yKParhl-kLc4hoha1en0D7fo",
      authDomain: "erb-sestem.firebaseapp.com",
      projectId: "erb-sestem",
      storageBucket: "erb-sestem.firebasestorage.app",
      messagingSenderId: "246580061197",
      appId: "1:246580061197:web:322bd35082c6b78a62a144"
    };

    const app = initializeApp(FIREBASE_CONFIG);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // =========================
    // App constants
    // =========================
    const TENANT_ID = "Main";
    const path = (...parts) => doc(db, "tenants", TENANT_ID, ...parts);
    const col = (...parts) => collection(db, "tenants", TENANT_ID, ...parts);

    // =========================
    // UI helpers
    // =========================
    const $ = (id) => document.getElementById(id);
    const fmt = (n) => (Number(n||0)).toLocaleString("ar-EG", {minimumFractionDigits:2, maximumFractionDigits:2});
    const todayISO = () => new Date().toISOString().slice(0,10);

    function toast(msg, type="info", title="تنبيه"){
      const t=$("toast");
      $("toastTitle").textContent=title;
      $("toastMsg").textContent=msg;
      const icon=$("toastIcon");
      icon.className="fa-solid " + (type==="good"?"fa-circle-check":type==="bad"?"fa-triangle-exclamation":"fa-circle-info");
      t.classList.add("show");
      clearTimeout(window.__toastTimer);
      window.__toastTimer=setTimeout(()=>t.classList.remove("show"), 3500);
    }

    // =========================
    // Local fallback storage (for offline)
    // =========================
    const LS_KEY="ERP_LOCAL_DB_V1";
    function loadLocal(){
      try{ return JSON.parse(localStorage.getItem(LS_KEY) || "{}"); }catch{ return {}; }
    }
    function saveLocal(obj){ localStorage.setItem(LS_KEY, JSON.stringify(obj||{})); }
    function ensureLocal(){
      const d=loadLocal();
      d.accounts ||= [];
      d.items ||= [];
      d.boms ||= [];
      d.productions ||= [];
      d.journals ||= [];
      d.journalLines ||= [];
      d.settings ||= {};
      saveLocal(d);
      return d;
    }

    // =========================
    // Current session
    // =========================
    let currentUser=null;
    let currentRole="viewer";
    let currentPerms={};
    let settingsCache=null;
    let accountsCache=[];
    let itemsCache=[];
    let partnersCache=[];
    let docsCache=[];

    // =========================
    // Permissions
    // =========================
    function can(key){
      if(currentRole==="admin") return true;
      if(currentPerms && key in currentPerms) return !!currentPerms[key];
      // defaults
      const viewKeys=["view_accounts","view_journal","view_reports","view_items","view_production","view_users","view_settings"];
      if(viewKeys.includes(key)) return true;
      return false;
    }

    // =========================
    // Auth mapping: username -> email (local domain)
    // =========================
    function usernameToEmail(u){
      const user=(u||"").trim().toLowerCase();
      if(!user) return "";
      if(user.includes("@")) return user;
      return `${user}@erb-sestem.local`;
    }

    // =========================
    // Firestore data ops
    // =========================
    async function fsGetSettings(){
      const ref=doc(db,"tenants",TENANT_ID,"settings","finance");
      const snap=await getDoc(ref);
      if(snap.exists()) return snap.data();
      return {
        companyName:"Main Company",
        fiscalYear:new Date().getFullYear(),
        lockTo:"",
        accInventory:"",
        accCOGS:"",
        accSales:"",
        accCash:"",
        companyAddress:"",
        companyPhone:"",
        companyTax:"",
        companyLogo:""
      };
    }
    async function fsSaveSettings(s){
      const ref=doc(db,"tenants",TENANT_ID,"settings","finance");
      await setDoc(ref, {...s, updatedAt: Date.now()}, {merge:true});
    }

    async function fsListAccounts(){
      const qs=await getDocs(query(col("accounts"), orderBy("code")));
      return qs.docs.map(d=>({id:d.id, ...d.data()}));
    }
    async function fsUpsertAccount(id,data){
      if(id){
        await setDoc(doc(db,"tenants",TENANT_ID,"accounts",id), {...data, updatedAt:Date.now()}, {merge:true});
      }else{
        await addDoc(col("accounts"), {...data, createdAt:Date.now(), updatedAt:Date.now()});
      }
    }
    async function fsDeleteAccount(id){
      await deleteDoc(doc(db,"tenants",TENANT_ID,"accounts",id));
    }

    async function fsListItems(){
      const qs=await getDocs(query(col("items"), orderBy("code")));
      return qs.docs.map(d=>({id:d.id, ...d.data()}));
    }
    async function fsUpsertItem(id,data){
      if(id){
        await setDoc(doc(db,"tenants",TENANT_ID,"items",id), {...data, updatedAt:Date.now()}, {merge:true});
      }else{
        await addDoc(col("items"), {...data, createdAt:Date.now(), updatedAt:Date.now()});
      }
    }
    async function fsDeleteItem(id){
      await deleteDoc(doc(db,"tenants",TENANT_ID,"items",id));
    }

    async function fsListUsers(){
      const qs=await getDocs(query(col("users"), orderBy("createdAt","desc")));
      return qs.docs.map(d=>({id:d.id, ...d.data()}));
    }
    async function fsUpsertUser(uid,data){
      await setDoc(doc(db,"tenants",TENANT_ID,"users",uid), {...data, updatedAt:Date.now()}, {merge:true});
    }

    
    // ===== Partners (Customers/Suppliers) =====
    async function fsListPartners(type=null){
      let qx = query(col("partners"), orderBy("name"));
      const qs=await getDocs(qx);
      let out = qs.docs.map(d=>({id:d.id, ...d.data()}));
      if(type) out = out.filter(p=>p.type===type);
      return out;
    }
    async function fsUpsertPartner(id,data){
      if(id){
        await setDoc(doc(db,"tenants",TENANT_ID,"partners",id), {...data, updatedAt:Date.now()}, {merge:true});
      }else{
        await addDoc(col("partners"), {...data, createdAt:Date.now(), updatedAt:Date.now()});
      }
    }

    // ===== Documents: Receipts / Payments =====
    async function fsListDocs(){
      const qs=await getDocs(query(col("documents"), orderBy("date","desc"), limit(50)));
      return qs.docs.map(d=>({id:d.id, ...d.data()}));
    }

    async function fsAddDoc(docHeader, docLines){
      const s = settingsCache || await fsGetSettings();
      if(!s.accCash) throw new Error("حدد حساب الصندوق من الإعدادات أولاً.");
      if(s.lockTo && docHeader.date <= s.lockTo) throw new Error("الفترة مقفلة حتى " + s.lockTo);

      const total = docLines.reduce((a,l)=>a+Number(l.amount||0),0);
      if(total<=0) throw new Error("أدخل بنود السند.");

      // Build journal
      const cashAcc = s.accCash;
      const isReceipt = docHeader.type==="receipt";
      const jHeader = {
        date: docHeader.date,
        memo: (isReceipt ? "سند قبض" : "سند صرف") + (docHeader.ref ? " - "+docHeader.ref : ""),
        source: "document",
        sourceId: "",
      };

      const jLines = [];
      // Cash side
      jLines.push({
        accountId: cashAcc,
        debit: isReceipt ? total : 0,
        credit: isReceipt ? 0 : total,
        memo: docHeader.note || "",
        partnerId: docHeader.partnerId || "",
        partnerType: docHeader.partnerType || "",
      });
      // Other lines
      for(const l of docLines){
        jLines.push({
          accountId: l.accountId,
          debit: isReceipt ? 0 : Number(l.amount||0),
          credit: isReceipt ? Number(l.amount||0) : 0,
          memo: l.memo || docHeader.note || "",
          partnerId: docHeader.partnerId || "",
          partnerType: docHeader.partnerType || "",
        });
      }

      const journalId = await fsAddJournal({date:jHeader.date, memo:jHeader.memo, source:jHeader.source}, jLines);

      // Save doc
      const dRef = await addDoc(col("documents"), {
        ...docHeader,
        total,
        journalId,
        createdAt:Date.now(),
        updatedAt:Date.now()
      });
      // Save doc lines
      for(const l of docLines){
        await addDoc(col("documentLines"), {...l, documentId:dRef.id, createdAt:Date.now()});
      }
      return {documentId:dRef.id, journalId};
    }
async function fsAddJournal(header, lines){
      // lock check
      const s = settingsCache || await fsGetSettings();
      if(s.lockTo && header.date <= s.lockTo){
        throw new Error("الفترة مقفلة حتى " + s.lockTo);
      }
      const hdr = {...header, posted:true, createdAt:Date.now(), updatedAt:Date.now()};
      const jRef = await addDoc(col("journals"), hdr);
      for(const ln of lines){
        await addDoc(col("journalLines"), {...ln, journalId:jRef.id, date:hdr.date, createdAt:Date.now()});
      }
      return jRef.id;
    }

    async function fsListJournals(){
      const qs=await getDocs(query(col("journals"), orderBy("date","desc"), limit(50)));
      return qs.docs.map(d=>({id:d.id, ...d.data()}));
    }

    async function fsComputeTrial(from,to){
      // Fetch lines within date range (client-side). For very large datasets, you would add indexes / cloud function aggregates.
      let qx = query(col("journalLines"), orderBy("date"));
      const qs = await getDocs(qx);
      const lines = qs.docs.map(d=>d.data()).filter(l => (!from || l.date>=from) && (!to || l.date<=to));
      const map = new Map();
      for(const l of lines){
        const k = l.accountId;
        const cur = map.get(k) || {debit:0, credit:0};
        cur.debit += Number(l.debit||0);
        cur.credit += Number(l.credit||0);
        map.set(k, cur);
      }
      const out = [];
      for(const a of accountsCache){
        const v=map.get(a.id) || {debit:0, credit:0};
        const bal = (v.debit - v.credit);
        if(v.debit!==0 || v.credit!==0){
          out.push({code:a.code, name:a.name, type:a.type, debit:v.debit, credit:v.credit, balance:bal});
        }
      }
      out.sort((x,y)=> String(x.code).localeCompare(String(y.code)));
      return out;
    }

    async function fsComputeBalances(to, type){
      let qx = query(col("journalLines"), orderBy("date"));
      const qs = await getDocs(qx);
      const lines = qs.docs.map(d=>d.data()).filter(l => (!to || l.date<=to));
      const map = new Map();
      for(const l of lines){
        const k = l.accountId;
        const cur = map.get(k) || 0;
        map.set(k, cur + (Number(l.debit||0) - Number(l.credit||0)));
      }
      const out = [];
      for(const a of accountsCache){
        if(type && type!=="all" && a.type!==type) continue;
        const bal = map.get(a.id) || 0;
        if(bal!==0){
          out.push({code:a.code, name:a.name, type:a.type, balance:bal});
        }
      }
      out.sort((x,y)=> Math.abs(y.balance)-Math.abs(x.balance));
      return out;
    }

    async function fsListBOM(){
      const qs=await getDocs(query(col("boms"), orderBy("createdAt","desc")));
      return qs.docs.map(d=>({id:d.id, ...d.data()}));
    }
    async function fsUpsertBOM(id,data){
      if(id){
        await setDoc(doc(db,"tenants",TENANT_ID,"boms",id), {...data, updatedAt:Date.now()}, {merge:true});
      }else{
        await addDoc(col("boms"), {...data, createdAt:Date.now(), updatedAt:Date.now()});
      }
    }
    async function fsListProductions(){
      const qs=await getDocs(query(col("productions"), orderBy("date","desc"), limit(50)));
      return qs.docs.map(d=>({id:d.id, ...d.data()}));
    }
    async function fsAddProduction(prod){
      await addDoc(col("productions"), {...prod, createdAt:Date.now(), updatedAt:Date.now()});
    }

    // =========================
    // Seed: create default accounts/items settings
    // =========================
    async function seedDefaults(){
      if(!can("manage_accounts")){ toast("لا تملك صلاحية إعداد الحسابات.", "bad"); return; }

      const defaults = [
        {code:"1000", name:"الأصول", type:"asset", parentCode:""},
        {code:"1100", name:"الصندوق والبنك", type:"asset", parentCode:"1000"},
        {code:"1200", name:"المخزون", type:"asset", parentCode:"1000"},
        {code:"2000", name:"الخصوم", type:"liability", parentCode:""},
        {code:"3000", name:"حقوق الملكية", type:"equity", parentCode:""},
        {code:"4000", name:"الإيرادات", type:"revenue", parentCode:""},
        {code:"4100", name:"المبيعات", type:"revenue", parentCode:"4000"},
        {code:"5000", name:"المصروفات", type:"expense", parentCode:""},
        {code:"5100", name:"تكلفة البضاعة المباعة", type:"expense", parentCode:"5000"},
      ];

      // Ensure tenant doc exists
      await setDoc(doc(db,"tenants",TENANT_ID), {name:"Main Company", updatedAt:Date.now()}, {merge:true});

      // load existing
      const existing = await fsListAccounts();
      const codes = new Set(existing.map(a=>a.code));
      // map parentCode -> parentId
      let codeToId = new Map(existing.map(a=>[a.code, a.id]));
      // insert in order
      for(const a of defaults){
        if(!codes.has(a.code)){
          const parentId = a.parentCode ? (codeToId.get(a.parentCode) || "") : "";
          const ref = await addDoc(col("accounts"), {
            code:a.code, name:a.name, type:a.type, parentId, createdAt:Date.now(), updatedAt:Date.now()
          });
          codeToId.set(a.code, ref.id);
        }
      }
      // refresh
      accountsCache = await fsListAccounts();
      await refreshAccountSelectors();
      // seed settings defaults if empty
      const s = await fsGetSettings();
      const invId = accountsCache.find(a=>a.code==="1200")?.id || "";
      const cogsId = accountsCache.find(a=>a.code==="5100")?.id || "";
      const salesId = accountsCache.find(a=>a.code==="4100")?.id || "";
      const cashId = accountsCache.find(a=>a.code==="1100")?.id || "";
      const upd = {
        ...s,
        companyName: s.companyName || "Main Company",
        fiscalYear: s.fiscalYear || new Date().getFullYear(),
        accInventory: s.accInventory || invId,
        accCOGS: s.accCOGS || cogsId,
        accSales: s.accSales || salesId,
        accCash: s.accCash || cashId,
      };
      await fsSaveSettings(upd);
      settingsCache = upd;

      toast("تم تجهيز الحسابات الافتراضية والإعدادات.", "good");
      await loadAllAndRender();
      go("accounts");
    }

    // =========================
    // UI rendering
    // =========================
    function setActiveNav(view){
      document.querySelectorAll("[data-view]").forEach(a=>{
        a.classList.toggle("active", a.getAttribute("data-view")===view);
      });
    }
    function showView(view){
      document.querySelectorAll(".view").forEach(v=>v.classList.add("hide"));
      $("view-"+view).classList.remove("hide");
      setActiveNav(view);
    }
    function go(view){
      // permission gates
      const map = {
        accounts:"view_accounts",
        journal:"view_journal",
        trial:"view_reports",
        balances:"view_reports",
        reports:"view_reports",
        ledger:"view_reports",
        statement:"view_reports",
        cash:"view_reports",
        payments:"view_journal",

        items:"view_items",
        bom:"view_production",
        production:"view_production",
        cogs:"view_reports",
        users:"view_users",
        settings:"view_settings",
        home:"view_reports"
      };
      const key = map[view] || "view_reports";
      if(!can(key)){
        toast("ليس لديك صلاحية لفتح هذه الشاشة.", "bad");
        return;
      }
      showView(view);
    }

    function renderAccounts(list){
      const q = ($("accSearch").value||"").trim().toLowerCase();
      const rows = list.filter(a=>{
        if(!q) return true;
        return String(a.code).includes(q) || String(a.name||"").toLowerCase().includes(q);
      }).map(a=>{
        const parent = accountsCache.find(x=>x.id===a.parentId);
        return `
          <tr>
            <td>${a.code||""}</td>
            <td>${a.name||""}</td>
            <td><span class="tag">${typeName(a.type)}</span></td>
            <td class="muted">${parent? parent.code+" - "+parent.name : "—"}</td>
            <td>
              <button class="btn" data-edit-acc="${a.id}"><i class="fa-solid fa-pen"></i></button>
              <button class="btn danger" data-del-acc="${a.id}"><i class="fa-solid fa-trash"></i></button>
            </td>
          </tr>`;
      }).join("");
      $("accTable").innerHTML = rows || `<tr><td colspan="5" class="muted">لا توجد حسابات. اضغط "تجهيز حسابات افتراضية" أو أضف حساب جديد.</td></tr>`;
      // actions
      document.querySelectorAll("[data-del-acc]").forEach(b=>{
        b.onclick = async ()=>{
          if(!can("manage_accounts")) return toast("لا تملك صلاحية.", "bad");
          const id=b.getAttribute("data-del-acc");
          if(!confirm("حذف الحساب؟")) return;
          await fsDeleteAccount(id);
          toast("تم الحذف.", "good");
          await loadAllAndRender();
        };
      });
      document.querySelectorAll("[data-edit-acc]").forEach(b=>{
        b.onclick = async ()=>{
          if(!can("manage_accounts")) return toast("لا تملك صلاحية.", "bad");
          const id=b.getAttribute("data-edit-acc");
          const a=accountsCache.find(x=>x.id===id);
          await openAccountModal(a);
        };
      });
    }

    function renderJournals(list){
      $("journalsTable").innerHTML = (list||[]).map(j=>{
        const st = j.posted ? `<span class="tag">مُرحّل</span>` : `<span class="tag">مسودة</span>`;
        return `<tr>
          <td>${j.date||""}</td>
          <td>${escapeHtml(j.memo||"")}</td>
          <td>${st}</td>
          <td><button class="btn" data-view-j="${j.id}"><i class="fa-solid fa-eye"></i></button></td>
        </tr>`;
      }).join("") || `<tr><td colspan="4" class="muted">لا توجد قيود بعد.</td></tr>`;

      document.querySelectorAll("[data-view-j]").forEach(b=>{
        b.onclick = async ()=>{
          const id=b.getAttribute("data-view-j");
          await showJournalDetails(id);
        };
      });
    }

    function renderTrial(rows){
      let td=0, tc=0, tb=0;
      const html = rows.map(r=>{
        td += r.debit; tc += r.credit; tb += r.balance;
        const balCls = r.balance>=0 ? "good-text" : "danger-text";
        return `<tr>
          <td>${r.code}</td>
          <td>${escapeHtml(r.name)}</td>
          <td>${fmt(r.debit)}</td>
          <td>${fmt(r.credit)}</td>
          <td class="${balCls}">${fmt(r.balance)}</td>
        </tr>`;
      }).join("");
      $("trialTable").innerHTML = html || `<tr><td colspan="5" class="muted">لا توجد حركة ضمن الفترة.</td></tr>`;
      $("trialTD").textContent = fmt(td);
      $("trialTC").textContent = fmt(tc);
      $("trialTB").textContent = fmt(tb);
    }

    function renderBalances(rows){
      $("balancesTable").innerHTML = rows.map(r=>{
        const balCls = r.balance>=0 ? "good-text" : "danger-text";
        return `<tr>
          <td>${r.code}</td>
          <td>${escapeHtml(r.name)}</td>
          <td class="${balCls}">${fmt(r.balance)}</td>
        </tr>`;
      }).join("") || `<tr><td colspan="3" class="muted">لا توجد أرصدة حتى هذا التاريخ.</td></tr>`;
    }


    function renderLedger(rows){
      let bal=0;
      const html = rows.map(r=>{
        bal = r.balance;
        return `<tr>
          <td>${r.date}</td>
          <td>${escapeHtml(r.memo||"")}</td>
          <td>${r.debit?fmt(r.debit):""}</td>
          <td>${r.credit?fmt(r.credit):""}</td>
          <td>${fmt(bal)}</td>
          <td class="muted">${r.journalId||""}</td>
        </tr>`;
      }).join("");
      $("ledgerTable").innerHTML = html || `<tr><td colspan="6" class="muted">لا توجد حركة.</td></tr>`;
    }

    function renderStatement(rows){
      let bal=0;
      const html = rows.map(r=>{
        bal = r.balance;
        return `<tr>
          <td>${r.date}</td>
          <td>${escapeHtml(r.memo||"")}</td>
          <td>${r.debit?fmt(r.debit):""}</td>
          <td>${r.credit?fmt(r.credit):""}</td>
          <td>${fmt(bal)}</td>
          <td class="muted">${r.journalId||""}</td>
        </tr>`;
      }).join("");
      $("stmtTable").innerHTML = html || `<tr><td colspan="6" class="muted">لا توجد حركة.</td></tr>`;
      $("stmtBal").textContent = fmt(bal);
    }

    function renderCash(rows){
      let bal=0;
      const html = rows.map(r=>{
        bal = r.balance;
        return `<tr>
          <td>${r.date}</td>
          <td>${escapeHtml(r.memo||"")}</td>
          <td>${r.receipt?fmt(r.receipt):""}</td>
          <td>${r.payment?fmt(r.payment):""}</td>
          <td>${fmt(bal)}</td>
          <td class="muted">${r.journalId||""}</td>
        </tr>`;
      }).join("");
      $("cashTable").innerHTML = html || `<tr><td colspan="6" class="muted">لا توجد حركة.</td></tr>`;
    }

    function renderDocs(list){
      $("docsTable").innerHTML = (list||[]).map(d=>{
        const t = d.type==="receipt" ? "قبض" : "صرف";
        return `<tr>
          <td>${d.date||""}</td>
          <td><span class="tag">${t}</span></td>
          <td>${escapeHtml(d.ref||"")}</td>
          <td>${fmt(d.total||0)}</td>
          <td class="muted">${d.journalId||""}</td>
        </tr>`;
      }).join("") || `<tr><td colspan="5" class="muted">لا توجد سندات بعد.</td></tr>`;
    }

    async function computeLedger(accountId, from, to){
      let qx = query(col("journalLines"), orderBy("date"));
      const qs = await getDocs(qx);
      const lines = qs.docs.map(d=>d.data()).filter(l=>(!accountId||l.accountId===accountId) && (!from||l.date>=from) && (!to||l.date<=to));
      let bal=0;
      return lines.map(l=>{
        bal += (Number(l.debit||0)-Number(l.credit||0));
        return {date:l.date, memo:l.memo||"", debit:Number(l.debit||0), credit:Number(l.credit||0), balance:bal, journalId:l.journalId||l.journalId};
      });
    }

    async function computeStatement(partnerId, from, to){
      let qx = query(col("journalLines"), orderBy("date"));
      const qs = await getDocs(qx);
      const lines = qs.docs.map(d=>d.data()).filter(l=>l.partnerId===partnerId && (!from||l.date>=from) && (!to||l.date<=to));
      let bal=0;
      return lines.map(l=>{
        bal += (Number(l.debit||0)-Number(l.credit||0));
        return {date:l.date, memo:l.memo||"", debit:Number(l.debit||0), credit:Number(l.credit||0), balance:bal, journalId:l.journalId||""};
      });
    }

    async function computeCash(cashAccId, from, to){
      let qx = query(col("journalLines"), orderBy("date"));
      const qs = await getDocs(qx);
      const lines = qs.docs.map(d=>d.data()).filter(l=>l.accountId===cashAccId && (!from||l.date>=from) && (!to||l.date<=to));
      let bal=0;
      return lines.map(l=>{
        const delta = (Number(l.debit||0)-Number(l.credit||0));
        bal += delta;
        return {date:l.date, memo:l.memo||"", receipt:Number(l.debit||0), payment:Number(l.credit||0), balance:bal, journalId:l.journalId||""};
      });
    }


    function renderItems(list){
      const q = ($("itemSearch").value||"").trim().toLowerCase();
      const rows = list.filter(i=>{
        if(!q) return true;
        return String(i.code).includes(q) || String(i.name||"").toLowerCase().includes(q);
      }).map(i=>{
        return `<tr>
          <td>${i.code||""}</td>
          <td>${escapeHtml(i.name||"")}</td>
          <td><span class="tag">${itemTypeName(i.type)}</span></td>
          <td>${fmt(i.avgCost||0)}</td>
          <td>${fmt(i.qtyOnHand||0)}</td>
          <td>
            <button class="btn" data-edit-item="${i.id}"><i class="fa-solid fa-pen"></i></button>
            <button class="btn danger" data-del-item="${i.id}"><i class="fa-solid fa-trash"></i></button>
          </td>
        </tr>`;
      }).join("");
      $("itemsTable").innerHTML = rows || `<tr><td colspan="6" class="muted">لا توجد مواد بعد.</td></tr>`;
      document.querySelectorAll("[data-del-item]").forEach(b=>{
        b.onclick = async ()=>{
          if(!can("manage_items")) return toast("لا تملك صلاحية.", "bad");
          const id=b.getAttribute("data-del-item");
          if(!confirm("حذف المادة؟")) return;
          await fsDeleteItem(id);
          toast("تم الحذف.", "good");
          await loadAllAndRender();
        };
      });
      document.querySelectorAll("[data-edit-item]").forEach(b=>{
        b.onclick = async ()=>{
          if(!can("manage_items")) return toast("لا تملك صلاحية.", "bad");
          const id=b.getAttribute("data-edit-item");
          const i=itemsCache.find(x=>x.id===id);
          await openItemModal(i);
        };
      });
    }

    function renderBOM(list){
      $("bomTable").innerHTML = list.map(b=>{
        const prod = itemsCache.find(i=>i.id===b.productItemId);
        return `<tr>
          <td>${prod ? (prod.code+" - "+escapeHtml(prod.name)) : "—"}</td>
          <td class="muted">${escapeHtml(b.memo||"")}</td>
          <td>${(b.components||[]).length}</td>
          <td><button class="btn" data-edit-bom="${b.id}"><i class="fa-solid fa-pen"></i></button></td>
        </tr>`;
      }).join("") || `<tr><td colspan="4" class="muted">لا توجد BOM.</td></tr>`;
      document.querySelectorAll("[data-edit-bom]").forEach(b=>{
        b.onclick = async ()=>{
          if(!can("manage_production")) return toast("لا تملك صلاحية.", "bad");
          const id=b.getAttribute("data-edit-bom");
          const bom = window.__boms.find(x=>x.id===id);
          await openBOMModal(bom);
        };
      });
    }

    function renderProductions(list){
      $("prodTable").innerHTML = list.map(p=>{
        const prod = itemsCache.find(i=>i.id===p.productItemId);
        const st = p.status==="done" ? `<span class="tag">مكتمل</span>` : `<span class="tag">مسودة</span>`;
        return `<tr>
          <td>${p.date||""}</td>
          <td>${prod? (prod.code+" - "+escapeHtml(prod.name)):"—"}</td>
          <td>${fmt(p.qty||0)}</td>
          <td>${st}</td>
          <td><button class="btn" data-open-prod="${p.id}"><i class="fa-solid fa-eye"></i></button></td>
        </tr>`;
      }).join("") || `<tr><td colspan="5" class="muted">لا توجد أوامر إنتاج.</td></tr>`;
      document.querySelectorAll("[data-open-prod]").forEach(b=>{
        b.onclick = async ()=>{
          const id=b.getAttribute("data-open-prod");
          const p = window.__prods.find(x=>x.id===id);
          await showProductionDetails(p);
        };
      });
    }

    function renderUsers(list){
      $("usersTable").innerHTML = list.map(u=>{
        return `<tr>
          <td class="muted">${u.id}</td>
          <td>${escapeHtml(u.displayName||"—")}</td>
          <td><span class="tag">${escapeHtml(u.role||"viewer")}</span></td>
          <td>${u.active ? `<span class="tag">نعم</span>` : `<span class="tag">لا</span>`}</td>
          <td><button class="btn" data-edit-user="${u.id}"><i class="fa-solid fa-pen"></i></button></td>
        </tr>`;
      }).join("") || `<tr><td colspan="5" class="muted">لا توجد مستخدمون معرفون في Firestore.</td></tr>`;
      document.querySelectorAll("[data-edit-user]").forEach(b=>{
        b.onclick = async ()=>{
          if(currentRole!=="admin") return toast("Admin فقط.", "bad");
          const uid=b.getAttribute("data-edit-user");
          const u = window.__users.find(x=>x.id===uid);
          await openUserPermModal(uid, u);
        };
      });
    }

    function typeName(t){
      return ({asset:"أصول", liability:"خصوم", equity:"حقوق", revenue:"إيرادات", expense:"مصروف"}[t]||t||"—");
    }
    function itemTypeName(t){
      return ({rm:"مواد خام", wip:"تحت التشغيل", fg:"تامة الصنع", service:"خدمة"}[t]||t||"—");
    }
    function escapeHtml(s){
      return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    async function refreshAccountSelectors(){
      const opts = ['<option value="">— اختر —</option>'].concat(
        accountsCache.map(a=>`<option value="${a.id}">${a.code} - ${escapeHtml(a.name)}</option>`)
      ).join("");
      $("jlAccount").innerHTML = opts;
      $("setAccInv").innerHTML = opts;
      $("setAccCOGS").innerHTML = opts;
      $("setAccSales").innerHTML = opts;
      $("setAccCash").innerHTML = opts;
      $("ledAcc").innerHTML = opts;
      $("cashAcc").innerHTML = opts;
    }

    
    function refreshPartnerSelectors(){
      const type = ($("stmtType")?.value)||"customer";
      const list = partnersCache.filter(p=>p.type===type);
      const opts = ['<option value="">— اختر —</option>'].concat(
        list.map(p=>`<option value="${p.id}">${escapeHtml(p.name)}</option>`)
      ).join("");
      if($("stmtPartner")) $("stmtPartner").innerHTML = opts;
      // docPartner includes both types
      const optsAll = ['<option value="">— بدون —</option>'].concat(
        partnersCache.map(p=>`<option value="${p.id}">${p.type==="customer"?"عميل":"مورد"}: ${escapeHtml(p.name)}</option>`)
      ).join("");
      if($("docPartner")) $("docPartner").innerHTML = optsAll;
    }

    async function loadAllAndRender(){
      $("envPill").textContent = "Firebase • Firestore";
      accountsCache = await fsListAccounts();
      await refreshAccountSelectors();
      itemsCache = await fsListItems();
      settingsCache = await fsGetSettings();
      // Partners & Documents
      partnersCache = await fsListPartners();
      refreshPartnerSelectors();

      docsCache = await fsListDocs();
      renderDocs(docsCache);

      // default dates for reports
      if($("ledFrom")) $("ledFrom").value ||= "";
      if($("ledTo")) $("ledTo").value ||= "";
      if($("stmtFrom")) $("stmtFrom").value ||= "";
      if($("stmtTo")) $("stmtTo").value ||= "";
      if($("cashFrom")) $("cashFrom").value ||= "";
      if($("cashTo")) $("cashTo").value ||= "";
      if($("docDate")) $("docDate").value = todayISO();


      // KPIs
      $("kpiAccounts").textContent = accountsCache.length;
      $("kpiItems").textContent = itemsCache.length;

      // Render screens
      renderAccounts(accountsCache);
      renderItems(itemsCache);

      // Journals
      const js = await fsListJournals();
      window.__journals = js;
      $("kpiJournals").textContent = js.length;
      renderJournals(js);

      // BOM & production
      const boms = await fsListBOM();
      window.__boms = boms;
      renderBOM(boms);

      const prods = await fsListProductions();
      window.__prods = prods;
      $("kpiProd").textContent = prods.length;
      renderProductions(prods);

      // Users
      const us = await fsListUsers();
      window.__users = us;
      renderUsers(us);

      // Settings UI
      $("setCompanyName").value = settingsCache.companyName || "";
      $("setFY").value = settingsCache.fiscalYear || new Date().getFullYear();
      $("setLockTo").value = settingsCache.lockTo || "";
      $("setAccInv").value = settingsCache.accInventory || "";
      $("setAccCOGS").value = settingsCache.accCOGS || "";
      $("setAccSales").value = settingsCache.accSales || "";
      $("setAccCash").value = settingsCache.accCash || "";
    }

    // =========================
    // Modals (simple prompt-based to keep single-file)
    // =========================
    async function openAccountModal(acc=null){
      const code = prompt("كود الحساب:", acc?.code||"");
      if(code===null) return;
      const name = prompt("اسم الحساب:", acc?.name||"");
      if(name===null) return;
      const type = prompt("نوع الحساب (asset/liability/equity/revenue/expense):", acc?.type||"asset");
      if(type===null) return;
      const parentCode = prompt("كود حساب الأب (اختياري):", acc?.parentId ? (accountsCache.find(a=>a.id===acc.parentId)?.code||"") : "");
      if(parentCode===null) return;
      const parentId = parentCode ? (accountsCache.find(a=>a.code===parentCode)?.id || "") : "";
      await fsUpsertAccount(acc?.id||"", {code, name, type, parentId});
      toast("تم حفظ الحساب.", "good");
      await loadAllAndRender();
    }

    async function openItemModal(item=null){
      const code = prompt("كود المادة:", item?.code||"");
      if(code===null) return;
      const name = prompt("اسم المادة:", item?.name||"");
      if(name===null) return;
      const type = prompt("نوع المادة (rm/wip/fg/service):", item?.type||"rm");
      if(type===null) return;
      const avgCost = Number(prompt("متوسط التكلفة:", item?.avgCost ?? 0) || 0);
      const qtyOnHand = Number(prompt("الرصيد (Qty On Hand):", item?.qtyOnHand ?? 0) || 0);
      await fsUpsertItem(item?.id||"", {code, name, type, avgCost, qtyOnHand});
      toast("تم حفظ المادة.", "good");
      await loadAllAndRender();
    }

    async function openBOMModal(bom=null){
      if(!itemsCache.length){ toast("أضف مواد أولاً.", "bad"); return; }
      const productCode = prompt("كود المنتج (Item Code) الذي له BOM:", bom ? (itemsCache.find(i=>i.id===bom.productItemId)?.code||"") : "");
      if(productCode===null) return;
      const product = itemsCache.find(i=>i.code===productCode);
      if(!product){ toast("لم يتم العثور على المنتج.", "bad"); return; }
      const memo = prompt("وصف/ملاحظة:", bom?.memo||"");
      if(memo===null) return;

      // components as text lines: CODE:QTY
      const currentText = (bom?.components||[]).map(c=>{
        const it=itemsCache.find(i=>i.id===c.itemId);
        return `${it?.code||"?"}:${c.qty}`;
      }).join("\n");
      const compText = prompt("اكتب المكوّنات كل سطر: CODE:QTY (مثال: RM01:2)", currentText);
      if(compText===null) return;
      const comps=[];
      for(const line of compText.split(/\r?\n/)){
        const l=line.trim(); if(!l) continue;
        const [cCode, cQty] = l.split(":").map(x=>x.trim());
        const it=itemsCache.find(i=>i.code===cCode);
        if(!it) { toast("مكوّن غير موجود: "+cCode, "bad"); return; }
        comps.push({itemId:it.id, qty:Number(cQty||0)});
      }

      await fsUpsertBOM(bom?.id||"", {productItemId: product.id, memo, components: comps});
      toast("تم حفظ BOM.", "good");
      await loadAllAndRender();
    }

    async function openUserPermModal(uid, u=null){
      const displayName = prompt("اسم العرض:", u?.displayName||"");
      if(displayName===null) return;
      const role = prompt("الدور (admin/accountant/viewer):", u?.role||"viewer");
      if(role===null) return;
      const active = confirm("هل المستخدم نشط؟ (OK=نعم / Cancel=لا)");
      const permsText = prompt("صلاحيات (JSON) اختياري. مثال: {"manage_accounts":true,"manage_items":true}", u?.permissions ? JSON.stringify(u.permissions) : "");
      if(permsText===null) return;
      let permissions={};
      if(permsText.trim()){
        try{ permissions = JSON.parse(permsText); }catch{ return toast("JSON غير صحيح.", "bad"); }
      }
      await fsUpsertUser(uid, {displayName, role, active, permissions, createdAt: u?.createdAt || Date.now()});
      toast("تم حفظ صلاحيات المستخدم.", "good");
      await loadAllAndRender();
    }

    async function showJournalDetails(journalId){
      const j = window.__journals.find(x=>x.id===journalId);
      if(!j) return;
      // load lines for this journal (client side filter)
      const qs = await getDocs(query(col("journalLines"), where("journalId","==",journalId)));
      const lines = qs.docs.map(d=>d.data());
      let msg = `التاريخ: ${j.date}\nالوصف: ${j.memo||""}\n\nالبنود:\n`;
      for(const l of lines){
        const a = accountsCache.find(x=>x.id===l.accountId);
        msg += `- ${a? a.code+" "+a.name:"?"} | مدين ${l.debit||0} | دائن ${l.credit||0} | ${l.costCenter||""}\n`;
      }
      alert(msg);
    }

    async function showProductionDetails(p){
      const prod = itemsCache.find(i=>i.id===p.productItemId);
      alert(`أمر إنتاج\nالتاريخ: ${p.date}\nالمنتج: ${prod? prod.code+" - "+prod.name:"—"}\nالكمية: ${p.qty}\nالحالة: ${p.status}`);
    }

    // =========================
    // Journal line builder
    // =========================
    let lineBuffer=[];
    function renderLineBuffer(){
      $("jlTable").innerHTML = lineBuffer.map((l,idx)=>{
        const a=accountsCache.find(x=>x.id===l.accountId);
        return `<tr>
          <td>${a? a.code+" - "+escapeHtml(a.name):"—"}</td>
          <td>${fmt(l.debit||0)}</td>
          <td>${fmt(l.credit||0)}</td>
          <td class="muted">${escapeHtml(l.costCenter||"")}</td>
          <td><button class="btn danger" data-del-line="${idx}"><i class="fa-solid fa-xmark"></i></button></td>
        </tr>`;
      }).join("") || `<tr><td colspan="5" class="muted">لا توجد بنود بعد.</td></tr>`;

      const sd = lineBuffer.reduce((s,l)=>s+Number(l.debit||0),0);
      const sc = lineBuffer.reduce((s,l)=>s+Number(l.credit||0),0);
      $("sumDebit").textContent = fmt(sd);
      $("sumCredit").textContent = fmt(sc);
      $("sumDiff").textContent = fmt(sd-sc);

      document.querySelectorAll("[data-del-line]").forEach(b=>{
        b.onclick = ()=>{
          const idx = Number(b.getAttribute("data-del-line"));
          lineBuffer.splice(idx,1);
          renderLineBuffer();
        };
      });
    }

    // =========================
    // COGS Report
    // =========================
    async function runCOGS(){
      const from=$("cFrom").value;
      const to=$("cTo").value;
      const qs=await getDocs(query(col("journals"), orderBy("date","desc"), limit(500)));
      const js=qs.docs.map(d=>({id:d.id, ...d.data()})).filter(j=>j.type==="SALE_COGS" && (!from || j.date>=from) && (!to || j.date<=to));
      let total=0;
      for(const j of js){
        total += Number(j.amount||0);
      }
      $("cogsTotal").textContent = fmt(total);
      toast("تم تحديث COGS.", "good");
    }

    // =========================
    // Print helper
    // =========================
    function printCurrent(title){
      const view = document.querySelector(".view:not(.hide)");
      if(!view) return;
      const w = window.open("", "_blank");
      w.document.write(`<html lang="ar" dir="rtl"><head><meta charset="utf-8"><title>${title}</title>
        <style>body{font-family:Arial;direction:rtl;margin:20px} table{width:100%;border-collapse:collapse} th,td{border:1px solid #ddd;padding:8px;text-align:right;font-size:12px} th{background:#f4f4f4}</style>
      </head><body>`);
      w.document.write(`<h3>${title}</h3>`);
      // clone relevant table
      const tbl = view.querySelector("table");
      if(tbl) w.document.write(tbl.outerHTML);
      w.document.write(`</body></html>`);
      w.document.close();
      w.focus();
      w.print();
    }

    // =========================
    // Events wiring
    // =========================
    $("btnShowConfig").onclick = ()=> $("configBox").classList.toggle("hide");
    $("btnOpenDocs").onclick = ()=> $("quickDoc").classList.toggle("hide");
    $("btnSeed").onclick = seedDefaults;

    $("btnLogin").onclick = async ()=>{
      const u = $("loginUser").value;
      const p = $("loginPass").value;
      const email = usernameToEmail(u);
      $("loginError").classList.add("hide");
      $("loginError").textContent = "";

      if(!email || !p){
        $("loginError").classList.remove("hide");
        $("loginError").innerHTML = "<b>تنبيه:</b> أدخل اسم المستخدم وكلمة المرور.";
        return;
      }

      try{
        await signInWithEmailAndPassword(auth, email, p);
      }catch(e){
        const code = e?.code || "";
        const msg = e?.message || String(e);

        // Friendly guidance for common Firebase Auth problems
        let help = "";
        if(code === "auth/unauthorized-domain"){
          help = `
          <br><br><b>سبب شائع:</b> هذا الدومين غير مسموح به داخل Firebase.
          <br><b>الحل:</b> Firebase Console → Authentication → Settings → Authorized domains
          <br>أضف: <b>moaeydsede.github.io</b> ثم احفظ.
          `;
        } else if(code === "auth/user-not-found" || code === "auth/wrong-password" || code === "auth/invalid-credential"){
          help = `
          <br><br><b>تأكد:</b>
          <br>1) في Authentication يوجد مستخدم Email: <b>${email}</b>
          <br>2) كلمة المرور صحيحة.
          `;
        } else if(code === "auth/network-request-failed"){
          help = `<br><br><b>تحقق من الإنترنت</b> ثم جرّب مرة أخرى.`;
        }

        $("loginError").classList.remove("hide");
        $("loginError").innerHTML = `<b>فشل تسجيل الدخول</b><br>${msg}${help}<br><br><span class="muted">Code: ${code||"N/A"}</span>`;
        console.error("LOGIN_ERROR", e);
      }
    };

    $("btnLogout").onclick = async ()=>{ await signOut(auth); };

    // Navigation
    document.querySelectorAll("[data-view]").forEach(a=>{
      a.onclick = (ev)=>{ ev.preventDefault(); go(a.getAttribute("data-view")); };
    });
    document.querySelectorAll("[data-go]").forEach(b=>{
      b.onclick = ()=> go(b.getAttribute("data-go"));
    });

    // Home
    $("btnRefreshHome").onclick = loadAllAndRender;

    // Accounts
    $("btnAddAccount").onclick = ()=> openAccountModal(null);
    $("btnReloadAccounts").onclick = loadAllAndRender;
    $("accSearch").oninput = ()=> renderAccounts(accountsCache);

    // Items
    $("btnAddItem").onclick = ()=> openItemModal(null);
    $("btnReloadItems").onclick = loadAllAndRender;
    $("itemSearch").oninput = ()=> renderItems(itemsCache);

    // BOM
    $("btnAddBOM").onclick = ()=> openBOMModal(null);
    $("btnReloadBOM").onclick = loadAllAndRender;

    // Production
    $("btnNewProd").onclick = async ()=>{
      if(!can("manage_production")) return toast("لا تملك صلاحية.", "bad");
      const date = prompt("تاريخ أمر الإنتاج (YYYY-MM-DD):", todayISO());
      if(date===null) return;
      const productCode = prompt("كود المنتج:", "");
      if(productCode===null) return;
      const product = itemsCache.find(i=>i.code===productCode);
      if(!product) return toast("المنتج غير موجود.", "bad");
      const qty = Number(prompt("الكمية:", "1")||0);
      if(!qty) return toast("كمية غير صحيحة.", "bad");

      // Try load BOM for product
      const boms = window.__boms || await fsListBOM();
      const bom = boms.find(b=>b.productItemId===product.id);
      if(!bom) return toast("لا توجد BOM لهذا المنتج.", "bad");

      // Calculate material cost
      let matCost=0;
      for(const c of bom.components){
        const it = itemsCache.find(i=>i.id===c.itemId);
        matCost += (Number(it?.avgCost||0) * Number(c.qty||0) * qty);
      }

      // Update inventory quantities (simplified)
      // Consume components
      for(const c of bom.components){
        const it = itemsCache.find(i=>i.id===c.itemId);
        if(!it) continue;
        const consume = Number(c.qty||0)*qty;
        const newQty = Number(it.qtyOnHand||0) - consume;
        await fsUpsertItem(it.id, {...it, qtyOnHand:newQty});
      }
      // Produce FG
      const fgNewQty = Number(product.qtyOnHand||0) + qty;
      await fsUpsertItem(product.id, {...product, qtyOnHand: fgNewQty});

      // Journal entry: Dr Inventory (FG) Cr Inventory (RM) is simplified; real-world uses WIP.
      // We'll record type "PRODUCTION" for reporting.
      const invAcc = settingsCache?.accInventory || "";
      if(invAcc){
        const header = {date, memo:`أمر إنتاج: ${product.code} x ${qty}`, type:"PRODUCTION", amount: matCost};
        const lines = [
          {accountId: invAcc, debit: matCost, credit:0, costCenter:"إنتاج"},
          {accountId: invAcc, debit:0, credit: matCost, costCenter:"إنتاج"},
        ];
        // This is a placeholder to keep journal balanced in single-account demo; you can map RM/FG accounts separately later.
        await fsAddJournal(header, lines);
      }

      await fsAddProduction({date, productItemId:product.id, qty, status:"done", bomId:bom.id, materialCost:matCost});
      toast("تم إنشاء أمر الإنتاج (مبسط).", "good");
      await loadAllAndRender();
      go("production");
    };
    $("btnReloadProd").onclick = loadAllAndRender;

    // Journal builder
    $("btnNewJournal").onclick = ()=>{
      lineBuffer=[];
      $("jDate").value=todayISO();
      $("jMemo").value="";
      renderLineBuffer();
      toast("جاهز لقيد جديد.", "good");
    };
    $("btnReloadJournals").onclick = loadAllAndRender;

    $("btnAddLine").onclick = ()=>{
      const accountId = $("jlAccount").value;
      const debit = Number($("jlDebit").value||0);
      const credit = Number($("jlCredit").value||0);
      const costCenter = $("jlCC").value || "";
      if(!accountId) return toast("اختر حساب.", "bad");
      if((debit<=0 && credit<=0) || (debit>0 && credit>0)) return toast("اكتب مدين أو دائن فقط.", "bad");
      lineBuffer.push({accountId, debit, credit, costCenter});
      $("jlDebit").value=""; $("jlCredit").value=""; $("jlCC").value="";
      renderLineBuffer();
    };

    $("btnPostJournal").onclick = async ()=>{
      if(!can("manage_journal")) return toast("لا تملك صلاحية.", "bad");
      const date = $("jDate").value || todayISO();
      const memo = $("jMemo").value || "";
      const sd = lineBuffer.reduce((s,l)=>s+Number(l.debit||0),0);
      const sc = lineBuffer.reduce((s,l)=>s+Number(l.credit||0),0);
      if(!lineBuffer.length) return toast("أضف بنود أولاً.", "bad");
      if(Math.abs(sd-sc) > 0.0001) return toast("القيد غير متوازن.", "bad");
      try{
        const id = await fsAddJournal({date, memo, type:"MANUAL", amount: sd}, lineBuffer);
        toast("تم حفظ وترحيل القيد: "+id, "good");
        lineBuffer=[]; renderLineBuffer();
        await loadAllAndRender();
      }catch(e){
        toast(String(e.message||e), "bad");
      }
    };

    // Reports
    $("tFrom").value = new Date(new Date().getFullYear(),0,1).toISOString().slice(0,10);
    $("tTo").value = todayISO();
    $("bTo").value = todayISO();
    $("cFrom").value = new Date(new Date().getFullYear(),0,1).toISOString().slice(0,10);
    $("cTo").value = todayISO();

    $("btnRunTrial").onclick = async ()=>{
      const rows = await fsComputeTrial($("tFrom").value, $("tTo").value);
      renderTrial(rows);
      toast("تم تحديث ميزان المراجعة.", "good");
    };
    $("btnPrintTrial").onclick = ()=> printCurrent("ميزان المراجعة");

    $("btnRunBalances").onclick = async ()=>{
      const rows = await fsComputeBalances($("bTo").value, $("balType").value);
      renderBalances(rows);
      toast("تم تحديث تقرير الأرصدة.", "good");
    };
    $("btnPrintBalances").onclick = ()=> printCurrent("تقرير الأرصدة");


    // Reports hub
    $("btnRefreshReports").onclick = ()=> toast("جاهز.", "good");

    // Ledger
    $("btnRunLedger").onclick = async ()=>{
      const rows = await computeLedger($("ledAcc").value, $("ledFrom").value, $("ledTo").value);
      renderLedger(rows);
      toast("تم تحديث دفتر الأستاذ.", "good");
    };
    $("btnPrintLedger").onclick = ()=> printCurrent("دفتر الأستاذ");

    // Statement
    $("stmtType").onchange = ()=> refreshPartnerSelectors();
    $("btnAddPartner").onclick = async ()=>{
      if(!can("manage_partners") && currentRole!=="admin"){ toast("لا تملك صلاحية إضافة.", "bad"); return; }
      const type = $("stmtType").value;
      const name = prompt(type==="customer"?"اسم العميل:":"اسم المورد:");
      if(!name) return;
      await fsUpsertPartner(null, {type, name});
      partnersCache = await fsListPartners();
      refreshPartnerSelectors();
      toast("تمت الإضافة.", "good");
    };
    $("btnRunStmt").onclick = async ()=>{
      const pid = $("stmtPartner").value;
      if(!pid) return toast("اختر عميل/مورد.", "bad");
      const rows = await computeStatement(pid, $("stmtFrom").value, $("stmtTo").value);
      renderStatement(rows);
      toast("تم تحديث كشف الحساب.", "good");
    };
    $("btnPrintStmt").onclick = ()=> printCurrent("كشف حساب");

    // Cash journal
    $("btnRunCash").onclick = async ()=>{
      const acc = $("cashAcc").value || (settingsCache?.accCash||"");
      if(!acc) return toast("حدد حساب الصندوق من الإعدادات.", "bad");
      const rows = await computeCash(acc, $("cashFrom").value, $("cashTo").value);
      renderCash(rows);
      toast("تم تحديث يومية الصندوق.", "good");
    };
    $("btnPrintCash").onclick = ()=> printCurrent("يومية الصندوق");

    // Documents
    window.__docLines = [];
    function renderDocLines(){
      const rows = window.__docLines.map((l,i)=>{
        const acc = accountsCache.find(a=>a.id===l.accountId);
        return `<tr>
          <td>${acc? (acc.code+" - "+escapeHtml(acc.name)) : ""}</td>
          <td>${fmt(l.amount||0)}</td>
          <td><button class="btn danger" data-delline="${i}"><i class="fa-solid fa-xmark"></i></button></td>
        </tr>`;
      }).join("");
      $("docLinesTable").innerHTML = rows || `<tr><td colspan="3" class="muted">لا توجد بنود. اضغط "إضافة سطر".</td></tr>`;
      $("docLinesCount").textContent = String(window.__docLines.length);
      const total = window.__docLines.reduce((a,x)=>a+Number(x.amount||0),0);
      $("docTotal").textContent = fmt(total);
      document.querySelectorAll("[data-delline]").forEach(b=>{
        b.onclick=()=>{
          const i=Number(b.getAttribute("data-delline"));
          window.__docLines.splice(i,1);
          renderDocLines();
        };
      });
    }

    $("btnNewDoc").onclick = ()=>{
      window.__docLines = [];
      $("docType").value="receipt";
      $("docDate").value=todayISO();
      $("docRef").value="";
      $("docNote").value="";
      $("docPartner").value="";
      renderDocLines();
      toast("سند جديد جاهز.", "good");
    };
    $("btnAddDocLine").onclick = ()=>{
      const code = prompt("كود الحساب للبند (مثال 1100):");
      if(!code) return;
      const acc = accountsCache.find(a=>String(a.code)===String(code).trim());
      if(!acc) return toast("لم يتم العثور على الحساب.", "bad");
      const amt = Number(prompt("المبلغ:", "0")||0);
      if(!(amt>0)) return;
      window.__docLines.push({accountId: acc.id, amount: amt});
      renderDocLines();
    };
    $("btnSaveDoc").onclick = async ()=>{
      try{
        const partnerId = $("docPartner").value || "";
        let partnerType="";
        if(partnerId){
          const p = partnersCache.find(x=>x.id===partnerId);
          partnerType = p?.type || "";
        }
        const payload = {
          type: $("docType").value,
          date: $("docDate").value || todayISO(),
          ref: $("docRef").value || "",
          note: $("docNote").value || "",
          partnerId,
          partnerType
        };
        const res = await fsAddDoc(payload, window.__docLines);
        toast("تم الحفظ والترحيل. القيد: "+res.journalId, "good");
        docsCache = await fsListDocs();
        renderDocs(docsCache);
        // refresh reports if open
      }catch(e){
        toast(e.message||String(e), "bad");
      }
    };
    $("btnReloadDocs").onclick = async ()=>{
      docsCache = await fsListDocs();
      renderDocs(docsCache);
      toast("تم التحديث.", "good");
    };



    $("btnRunCOGS").onclick = runCOGS;

    // Users
    $("btnAddUserPerm").onclick = async ()=>{
      if(currentRole!=="admin") return toast("Admin فقط.", "bad");
      const uid = prompt("UID المستخدم من Firebase Auth:", "");
      if(uid===null) return;
      if(!uid.trim()) return;
      await openUserPermModal(uid.trim(), null);
    };
    $("btnReloadUsers").onclick = loadAllAndRender;

    // Settings
    
    $("btnCompanyInfo").onclick = async ()=>{
      if(!can("manage_settings")) return toast("لا تملك صلاحية.", "bad");
      const name = prompt("اسم الشركة:", settingsCache?.companyName||"");
      if(name===null) return;
      const address = prompt("عنوان الشركة:", settingsCache?.companyAddress||"");
      if(address===null) return;
      const phone = prompt("هاتف الشركة:", settingsCache?.companyPhone||"");
      if(phone===null) return;
      const tax = prompt("الرقم الضريبي (اختياري):", settingsCache?.companyTax||"");
      if(tax===null) return;
      const logo = prompt("رابط شعار (اختياري):", settingsCache?.companyLogo||"");
      if(logo===null) return;
      const upd = {...(settingsCache||{}), companyName:name, companyAddress:address, companyPhone:phone, companyTax:tax, companyLogo:logo};
      await fsSaveSettings(upd);
      settingsCache = upd;
      $("setCompanyName").value = name;
      toast("تم حفظ بيانات الشركة.", "good");
    };

$("btnSaveSettings").onclick = async ()=>{
      if(!can("manage_settings")) return toast("لا تملك صلاحية.", "bad");
      const s = {
        companyName: $("setCompanyName").value || "Main Company",
        fiscalYear: Number($("setFY").value||new Date().getFullYear()),
        lockTo: $("setLockTo").value || "",
        accInventory: $("setAccInv").value || "",
        accCOGS: $("setAccCOGS").value || "",
        accSales: $("setAccSales").value || "",
        accCash: $("setAccCash").value || "",
      };
      await fsSaveSettings(s);
      settingsCache = s;
      toast("تم حفظ الإعدادات.", "good");
    };

    $("btnLocalReset").onclick = ()=>{
      if(!confirm("مسح البيانات المحلية؟")) return;
      localStorage.removeItem(LS_KEY);
      toast("تم مسح البيانات المحلية.", "good");
    };
    $("btnExportLocal").onclick = ()=>{
      const data = ensureLocal();
      const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
      const a=document.createElement("a");
      a.href=URL.createObjectURL(blob);
      a.download="ERP_LOCAL_EXPORT.json";
      a.click();
    };
    $("btnImportLocal").onclick = ()=> $("importFile").click();
    $("importFile").onchange = async (e)=>{
      const f=e.target.files?.[0];
      if(!f) return;
      const txt=await f.text();
      try{
        const obj=JSON.parse(txt);
        saveLocal(obj);
        toast("تم الاستيراد محليًا.", "good");
      }catch{
        toast("ملف JSON غير صحيح.", "bad");
      }finally{
        e.target.value="";
      }
    };

    // =========================
    // Auth state
    // =========================
    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        currentUser=null;
        $("userPill").querySelector("span").textContent="زائر";
        $("btnLogout").style.display="none";
        $("loginView").classList.remove("hide");
        $("appView").classList.add("hide");
        $("bottomNav").style.display="none";
        return;
      }
      currentUser=user;
      $("btnLogout").style.display="inline-flex";

      // Load user role from Firestore
      try{
        const uRef = doc(db,"tenants",TENANT_ID,"users",user.uid);
        const snap = await getDoc(uRef);
        if(!snap.exists()){
          $("userPill").querySelector("span").textContent="غير مُفعّل";
          toast("تم الدخول، لكن حسابك غير مُفعّل في Firestore. أضف وثيقة users/{uid}.", "bad", "صلاحيات");
          // still show app with viewer minimal
          currentRole="viewer";
          currentPerms={};
        }else{
          const uData = snap.data();
          if(uData.active === false){
            toast("حسابك غير نشط. تواصل مع Admin.", "bad", "صلاحيات");
            await signOut(auth);
            return;
          }
          currentRole = uData.role || "viewer";
          currentPerms = uData.permissions || {};
          $("userPill").querySelector("span").textContent = (uData.displayName||"مستخدم") + " • " + currentRole;
          $("roleTag").textContent = "Role: " + currentRole;
        }

        // Show app
        $("loginView").classList.add("hide");
        $("appView").classList.remove("hide");
        // mobile bottom nav only on small screens
        if(window.matchMedia("(max-width: 999px)").matches){
          $("bottomNav").style.display="block";
        }else{
          $("bottomNav").style.display="none";
        }

        // default dates + start view
        $("jDate").value = todayISO();
        // load data
        await loadAllAndRender();
        go("home");
      }catch(e){
        toast("خطأ في تحميل الصلاحيات: "+String(e.message||e), "bad");
      }
    });

    // Resize handler for bottom nav
    window.addEventListener("resize", ()=>{
      if(!$("appView").classList.contains("hide")){
        $("bottomNav").style.display = window.matchMedia("(max-width: 999px)").matches ? "block" : "none";
      }
    });

    // Seed local structure
    ensureLocal();

    // Quick action buttons
    document.querySelectorAll("[data-go]").forEach(b=>{
      b.onclick = ()=>go(b.getAttribute("data-go"));
    });

    // Default view for unauth
    $("loginUser").value="admin";
    $("loginPass").value="admin123";
  </script>
</body>
</html>
